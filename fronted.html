<meta name="referrer" content="no-referrer">
<style>
  :root {
    --custom-border-color: rgba(244, 244, 244, 0.382);
    --custom-boxshadow-color: rgba(244, 244, 244, 0.5);
    --custom-background-color: rgba(244, 244, 244, 0.618);
    --custom-border-color-dark: rgba(11, 11, 11, 0.382);
    --custom-boxshadow-color-dark: rgba(11, 11, 11, 0.5);
    --custom-background-color-dark: rgba(11, 11, 11, 0.618);
    --custom-background-image: unset;
  }

  /* common */
  #root {
    background-color: unset !important;
  }

  img {
    border: none;
  }

  /* 背景图片压暗和模糊, 开了背景图建议开启 */
  .dark .bg-cover::after {
    content: "";
    position: absolute;
    inset: 0;
    backdrop-filter: blur(6px);
    background-color: rgba(0, 0, 0, 0.3);
  }

  .light .bg-cover::after {
    content: "";
    position: absolute;
    inset: 0;
    backdrop-filter: blur(3px);
    background-color: rgba(255, 255, 255, 0.3);
  }

  .text-green-600 {
    color: rgb(34, 197, 94);
  }

  .bg-green-600 {
    background-color: rgb(34, 197, 94);
  }

  .vps-info {
    border-radius: 12px;
    padding: 12px;
  }

  img[alt="BackIcon"] {
    margin-right: 12px;
  }

  .flex.items-center.gap-1.rounded-\[50px\].bg-stone-100.p-\[3px\].dark\:bg-stone-800 {
    backdrop-filter: blur(2px);
  }

  .data-\[state\=unchecked\]\:bg-input[data-state=unchecked] {
    background-color: unset;
  }

  /* Light Mode */
  .light .bg-card {
    font-family: "Roboto", "Segoe UI", "Helvetica Neue", Helvetica, Arial, sans-serif;
    position: relative;
    /* 设置元素为相对定位 */
    background-color: var(--custom-background-color);
    border: 1px solid var(--custom-border-color);
    backdrop-filter: blur(5px);
    border-radius: 15px;
    /* 设置边框圆角为15像素 */
    overflow: hidden;
    /* 确保内容不会溢出容器 */
    box-shadow: 0 4px 6px var(--custom-boxshadow-color);
    /* 设置阴影 */
  }

  .light .focus\:text-accent-foreground:focus {
    background-color: var(--custom-background-color);
  }

  .light .text-muted-foreground {
    color: #000;
  }

  .light\:bg-stone-700:is(.light *) {
    --tw-bg-opacity: 0.5;
  }

  html.light * {
    border-color: var(--custom-border-color);
  }

  html.light body {
    color: #0b0a09;
    background: unset;
    position: relative;
  }

  .border-neutral-200:is(.light *) {
    border-color: var(--custom-border-color);
  }

  .fill-neutural-200\/50:is(.light *) {
    fill: var(--custom-background-color);
  }

  .light .bg-stone-100 {
    background: var(--custom-background-color);
  }

  .light\:text-stone-500:is(.light *) {
    color: #0b0a09;
  }

  .light .bg-muted {
    background-color: var(--custom-border-color);
  }

  .bg-white:is(.light *) {
    background-color: var(--custom-boxshadow-color)
  }

  .light .bg-border {
    background-color: var(--custom-border-color);
  }

  .light .border-input {
    border-color: var(--custom-border-color);
  }

  .text-neutral-600\/50:is(.light *) {
    color: #666;
  }

  .text-stone-400:is(.light *) {
    color: #000;
  }

  .light div#radix-\:r4\: {
    background: rgba(255, 255, 255, 0.7);
  }

  .light .max-w-5xl.gap-4>div:first-child {
    background-color: var(--custom-background-color);
    backdrop-filter: blur(2px);
    border: 1px solid var(--custom-boxshadow-color);
    box-shadow: 0 4px 6px var(--custom-boxshadow-color);
    border-radius: 12px;
    padding: 12px;
  }

  .light .\[\&_\.recharts-cartesian-axis-tick_text\]\:fill-muted-foreground .recharts-cartesian-axis-tick text {
    fill: #000;
  }

  .light .data-\[state\=checked\]\:bg-primary[data-state=checked] {
    background-color: var(--custom-background-color);
  }

  .bg-neutral-100:is(.light *) {
    background-color: var(--custom-background-color);
  }

  .light .bg-secondary {
    background-color: unset;
  }

  .light .bg-popover {
    background-color: var(--custom-boxshadow-color);
  }

  .light .font-medium.opacity-40 {
    opacity: unset;
  }

  .light .font-medium.opacity-50 {
    opacity: unset;
  }

  /* Dark Mode */
  .dark .bg-card {
    font-family: "Roboto", "Segoe UI", "Helvetica Neue", Helvetica, Arial, sans-serif;
    position: relative;
    /* 设置元素为相对定位 */
    background-color: var(--custom-background-color-dark);
    border: 1px solid var(--custom-border-color-dark);
    backdrop-filter: blur(5px);
    border-radius: 15px;
    /* 设置边框圆角为15像素 */
    overflow: hidden;
    /* 确保内容不会溢出容器 */
    box-shadow: 0 4px 6px var(--custom-boxshadow-color-dark);
    /* 设置阴影 */
  }

  .dark .focus\:text-accent-foreground:focus {
    background-color: var(--custom-background-color-dark);
  }

  .dark .text-muted-foreground {
    color: #fff;
  }

  .dark\:bg-stone-700:is(.dark *) {
    --tw-bg-opacity: 0.5;
  }

  html.dark * {
    border-color: var(--custom-border-color-dark);
  }

  html.dark body {
    color: #f4f5f6;
    background: unset;
    position: relative;
  }

  .dark\:border-neutral-800:is(.dark *) {
    border-color: var(--custom-border-color-dark);
  }

  .dark\:fill-neutral-800:is(.dark *) {
    fill: var(--custom-background-color-dark);
  }

  .dark .bg-stone-800 {
    background: var(--custom-background-color-dark);
  }

  .dark\:text-stone-500:is(.dark *) {
    color: #f4f5f6;
  }

  .dark .bg-muted {
    background-color: var(--custom-border-color-dark);
  }

  .dark\:bg-black:is(.dark *) {
    background-color: var(--custom-boxshadow-color-dark)
  }

  .dark .bg-border {
    background-color: var(--custom-border-color-dark);
  }

  .dark .border-input {
    border-color: var(--custom-border-color-dark);
  }

  .dark\:text-neutral-300\/50:is(.dark *) {
    color: #999;
  }

  .dark\:text-stone-400:is(.dark *) {
    color: #fff;
  }

  .dark div#radix-\:r4\: {
    background: rgba(0, 0, 0, 0.7);
  }

  .dark .max-w-5xl.gap-4>div:first-child {
    background-color: var(--custom-background-color-dark);
    backdrop-filter: blur(2px);
    border: 1px solid var(--custom-boxshadow-color-dark);
    box-shadow: 0 4px 6px var(--custom-boxshadow-color-dark);
    border-radius: 12px;
    padding: 12px;
  }

  .dark .\[\&_\.recharts-cartesian-axis-tick_text\]\:fill-muted-foreground .recharts-cartesian-axis-tick text {
    fill: #fff;
  }

  .dark .data-\[state\=checked\]\:bg-primary[data-state=checked] {
    background-color: var(--custom-background-color-dark);
  }

  .bg-neutral-800:is(.dark *) {
    background-color: var(--custom-background-color-dark);
  }

  .dark .bg-secondary {
    background-color: unset;
  }

  .dark .bg-popover {
    background-color: var(--custom-boxshadow-color-dark);
  }

  .dark .font-medium.opacity-40 {
    opacity: unset;
  }

  .dark .font-medium.opacity-50 {
    opacity: unset;
  }

  /* 不显示自带流量卡片 */
  .mt-4.w-full.mx-auto>div {
    display: none;
  }
</style>

<script>
  //window.CustomBackgroundImage = "https://w.wallhaven.cc/full/q6/wallhaven-q6jvjl.jpg";
  window.CustomBackgroundImage = "https://bing.img.run/rand_uhd.php"; /* 页面背景图 */
  window.CustomMobileBackgroundImage = "https://bing.img.run/rand_m.php"; /* 移动端页面背景图 */
  /* 卡片显示上下行流量 */
  window.ShowNetTransfer = "true";
  /* 关掉人物插图 */
  window.DisableAnimatedMan = "true";
  /* 自定义描述 */
  window.CustomDesc = "v2.games";

  /* 修改页脚, 可使用 HTML 元素, 请保留哪吒版权信息, 与下方 CSS 中的 不显示页脚 冲突 */
  /* 左侧哪吒文本 */
  const observerFooterLeft = new MutationObserver(() => {
    const footerLeft = document.querySelector(
      ".server-footer-name > div:first-child"
    );
    if (footerLeft) {
      footerLeft.style.visibility = "hidden"; // 隐藏
      observerFooterLeft.disconnect();
    }
  });
  observerFooterLeft.observe(document.body, { childList: true, subtree: true });
  /* 右侧主题文本 */
  const observerFooterRight = new MutationObserver(() => {
    const footerRight = document.querySelector(".server-footer-theme");
    if (footerRight) {
      footerRight.innerHTML = "<section></section>";
      observerFooterRight.disconnect();
    }
  });
  observerFooterRight.observe(document.body, {
    childList: true,
    subtree: true,
  });
</script>

<script>
  ; (function () {
    let trafficTimer = null;
    let trafficCache = null;

    const config = {
      showTrafficStats: true,
      insertPosition: 'replace', // 可选：'after', 'before', 'replace'
      interval: 60000,           // 60秒刷新周期
      style: 1
    };

    function formatFileSize(bytes) {
      if (bytes === 0) return { value: '0', unit: 'B' };
      const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
      let unitIndex = 0;
      let size = bytes;
      while (size >= 1024 && unitIndex < units.length - 1) {
        size /= 1024;
        unitIndex++;
      }
      return {
        value: size.toFixed(unitIndex === 0 ? 0 : 2),
        unit: units[unitIndex]
      };
    }

    function calculatePercentage(used, total) {
      used = Number(used);
      total = Number(total);
      if (used > 1e15 || total > 1e15) {
        used /= 1e10;
        total /= 1e10;
      }
      return (used / total * 100).toFixed(1);
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    }

    function safeSetTextContent(parent, selector, text) {
      const el = parent.querySelector(selector);
      if (el) {
        el.textContent = text;
      }
    }

    function renderTrafficStats(trafficData) {
      const serverMap = new Map();

      for (const cycleId in trafficData) {
        const cycle = trafficData[cycleId];
        if (!cycle.server_name || !cycle.transfer) continue;

        for (const serverId in cycle.server_name) {
          const serverName = cycle.server_name[serverId];
          const transfer = cycle.transfer[serverId];
          const max = cycle.max;
          const from = cycle.from;
          const to = cycle.to;
          const next_update = cycle.next_update[serverId];

          if (serverName && transfer !== undefined && max && from && to) {
            serverMap.set(serverName, {
              id: serverId,
              transfer: transfer,
              max: max,
              name: cycle.name,
              from: from,
              to: to,
              next_update: next_update
            });
          }
        }
      }

      const isInline = !!document.querySelector('section.server-inline-list');
      console.log(`[调试] 当前布局是 ${isInline ? 'inline' : 'standard'}`);
      serverMap.forEach((serverData, serverName) => {
        const targetElement = Array.from(document.querySelectorAll('section.grid.items-center.gap-2'))
          .find(el => el.textContent.trim().includes(serverName));
        if (!targetElement) {
          //console.warn(`[renderTrafficStats] 未找到服务器 "${serverName}" (ID: ${serverData.id}) 的元素`);
          return;
        }

        const usedFormatted = formatFileSize(serverData.transfer);
        const totalFormatted = formatFileSize(serverData.max);
        const percentage = calculatePercentage(serverData.transfer, serverData.max);
        const fromFormatted = formatDate(serverData.from);
        const toFormatted = formatDate(serverData.to);
        const next_update = new Date(serverData.next_update).toLocaleString("zh-CN", { timeZone: "Asia/Shanghai" });
        const uniqueClassName = 'traffic-stats-for-server-' + serverData.id;
        let insertPosition = config.insertPosition;

        const containerDiv = targetElement.closest('div');
        let oldSection = containerDiv.querySelector('section.flex.items-center.w-full.justify-between.gap-1');
        if (!oldSection) {
          oldSection = containerDiv.querySelector('section.grid.grid-cols-5.items-center.gap-3');
          insertPosition = 'after';
        }
        if (isInline) 
        {
          oldSection = containerDiv.querySelector('section.grid.grid-cols-9.items-center.gap-3');
          insertPosition = 'after';
        }
        const existing = containerDiv.querySelector('.' + uniqueClassName);

        if (config.showTrafficStats) {
          if (existing) {
            safeSetTextContent(existing, '.used-traffic', usedFormatted.value);
            safeSetTextContent(existing, '.used-unit', usedFormatted.unit);
            safeSetTextContent(existing, '.total-traffic', totalFormatted.value);
            safeSetTextContent(existing, '.total-unit', totalFormatted.unit);
            safeSetTextContent(existing, '.from-date', fromFormatted);
            safeSetTextContent(existing, '.to-date', toFormatted);
            safeSetTextContent(existing, '.percentage-value', percentage + '%');
            safeSetTextContent(existing, '.next-update', `next update: ${next_update}`);
            const progressBar = existing.querySelector('.progress-bar');
            if (progressBar) {
              progressBar.style.width = percentage + '%';
            }
            console.log(`[renderTrafficStats] 更新已存在的流量条目: ${serverName}`);
          } else if (oldSection) {
            const newElement = document.createElement('div');
            newElement.classList.add('space-y-1.5', 'new-inserted-element', uniqueClassName);
            newElement.style.width = '100%';
            if (config.style === 1) {
              newElement.innerHTML = `
                <div class="flex items-center justify-between">
                  <div class="flex items-baseline gap-1">
                    <span class="text-[10px] font-medium text-neutral-800 dark:text-neutral-200 used-traffic">${usedFormatted.value}</span>
                    <span class="text-[10px] font-medium text-neutral-800 dark:text-neutral-200 used-unit">${usedFormatted.unit}</span>
                    <span class="text-[10px] text-neutral-500 dark:text-neutral-400">/ </span>
                    <span class="text-[10px] text-neutral-500 dark:text-neutral-400 total-traffic">${totalFormatted.value}</span>
                    <span class="text-[10px] text-neutral-500 dark:text-neutral-400 total-unit">${totalFormatted.unit}</span>
                  </div>
                  <div class="text-[10px] font-medium text-neutral-600 dark:text-neutral-300">
                    <span class="from-date">${fromFormatted}</span>
                    <span class="text-neutral-500 dark:text-neutral-400">-</span>
                    <span class="to-date">${toFormatted}</span>
                  </div>
                </div>
                <div class="relative h-1.5">
                  <div class="absolute inset-0 bg-neutral-100 dark:bg-neutral-800 rounded-full"></div>
                  <div class="absolute inset-0 bg-emerald-500 rounded-full transition-all duration-300 progress-bar" style="width: ${percentage}%;"></div>
                </div>
              `;
            } else if (config.style === 2) {
              newElement.innerHTML = `
                <div class="flex items-center justify-between">
                  <div class="flex items-baseline gap-1">
                    <span class="text-[10px] font-medium text-neutral-800 dark:text-neutral-200 used-traffic">${usedFormatted.value}</span>
                    <span class="text-[10px] font-medium text-neutral-800 dark:text-neutral-200 used-unit">${usedFormatted.unit}</span>
                    <span class="text-[10px] text-neutral-500 dark:text-neutral-400">/ </span>
                    <span class="text-[10px] text-neutral-500 dark:text-neutral-400 total-traffic">${totalFormatted.value}</span>
                    <span class="text-[10px] text-neutral-500 dark:text-neutral-400 total-unit">${totalFormatted.unit}</span>
                  </div>
                  <span class="text-[10px] text-neutral-500 dark:text-neutral-400 percentage-value">${percentage}%</span>
                </div>
                <div class="relative h-1.5">
                  <div class="absolute inset-0 bg-neutral-100 dark:bg-neutral-800 rounded-full"></div>
                  <div class="absolute inset-0 bg-emerald-500 rounded-full transition-all duration-300 progress-bar" style="width: ${percentage}%;"></div>
                </div>
                <div class="flex items-center justify-between">
                  <div class="text-[10px] text-neutral-500 dark:text-neutral-400">
                    <span class="from-date">${fromFormatted}</span>
                    <span class="text-neutral-500 dark:text-neutral-400">-</span>
                    <span class="to-date">${toFormatted}</span>
                  </div>
                  <span class="text-[10px] text-neutral-500 dark:text-neutral-400">next update: ${next_update}</span>
                </div>
              `;
            }
            if (insertPosition === 'before') oldSection.before(newElement);
            else if (insertPosition === 'replace') oldSection.replaceWith(newElement);
            else oldSection.after(newElement);
            console.log(`[renderTrafficStats] 插入新流量条目: ${serverName}，插入方式: ${insertPosition}`);
          }
        } else {
          if (existing) {
            existing.remove();
            console.log(`[renderTrafficStats] 已隐藏流量条目: ${serverName}`);
          }
        }
      });
    }

    function updateTrafficStats(force = false) {
      const now = Date.now();
      if (!force && trafficCache && (now - trafficCache.timestamp < config.interval)) {
        console.log('[updateTrafficStats] 使用缓存数据');
        renderTrafficStats(trafficCache.data);
        return;
      }

      console.log('[updateTrafficStats] 正在请求新数据...');
      fetch('/api/v1/service')
        .then(res => res.json())
        .then(data => {
          if (!data.success) {
            console.warn('[updateTrafficStats] 请求成功但返回数据异常');
            return;
          }
          console.log('[updateTrafficStats] 成功获取新数据');
          const trafficData = data.data.cycle_transfer_stats;
          trafficCache = {
            timestamp: now,
            data: trafficData
          };
          renderTrafficStats(trafficData);
        })
        .catch(err => console.error('[updateTrafficStats] 获取失败:', err));
    }

    function startPeriodicRefresh() {
      if (!trafficTimer) {
        console.log('[startPeriodicRefresh] 启动周期刷新任务');
        trafficTimer = setInterval(() => {
          updateTrafficStats();
        }, config.interval);
      }
    }

    function onDomChildListChange() {
      console.log('[onDomChildListChange] 检测到DOM变化, 立即刷新');
      updateTrafficStats();
      if (!trafficTimer) {
        console.log('[onDomChildListChange] 启动定时刷新');
        startPeriodicRefresh();
      }
    }

    const observer = new MutationObserver(mutations => {
      for (const mutation of mutations) {
        if (mutation.type === 'childList') {
          const nodes = [...mutation.addedNodes, ...mutation.removedNodes];
          const matched = nodes.some(node => {
            if (node.nodeType !== 1 || !node.querySelectorAll) return false;
            return Array.from(node.querySelectorAll('span.text-muted-foreground'))
              .some(el => Array.from(el.classList).some(cls => cls.includes('text-[')));
          });

          if (matched) {
            onDomChildListChange();
            break;
          }
        }
      }
    });

    const targetNode = document.querySelector('main') || document.body;

    observer.observe(targetNode, {
      childList: true,
      subtree: true
    });

    updateTrafficStats(true);  // 初始强制刷新
    startPeriodicRefresh();

    window.addEventListener('beforeunload', () => {
      if (trafficTimer) clearInterval(trafficTimer);
      observer.disconnect();
    });
  })();
</script>
