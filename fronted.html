<meta name="referrer" content="no-referrer">
<style>
    :root {
        --custom-border-color: rgba(244, 244, 244, 0.382);
        --custom-boxshadow-color: rgba(244, 244, 244, 0.5);
        --custom-background-color: rgba(244, 244, 244, 0.618);
        --custom-border-color-dark: rgba(11, 11, 11, 0.382);
        --custom-boxshadow-color-dark: rgba(11, 11, 11, 0.5);
        --custom-background-color-dark: rgba(11, 11, 11, 0.618);
        --custom-background-image: unset;
    }

    /* common */
    #root {
        background-color: unset !important;
    }

    img {
        border: none;
    }

    /* 背景图片压暗和模糊, 开了背景图建议开启 */
    .dark .bg-cover::after {
        content: "";
        position: absolute;
        inset: 0;
        backdrop-filter: blur(6px);
        background-color: rgba(0, 0, 0, 0.3);
    }

    .light .bg-cover::after {
        content: "";
        position: absolute;
        inset: 0;
        backdrop-filter: blur(3px);
        background-color: rgba(255, 255, 255, 0.3);
    }

    .text-green-600 {
        color: rgb(34, 197, 94);
    }

    .bg-green-600 {
        background-color: rgb(34, 197, 94);
    }

    .vps-info {
        border-radius: 12px;
        padding: 12px;
    }

    img[alt="BackIcon"] {
        margin-right: 12px;
    }

    .flex.items-center.gap-1.rounded-\[50px\].bg-stone-100.p-\[3px\].dark\:bg-stone-800 {
        backdrop-filter: blur(2px);
    }

    .data-\[state\=unchecked\]\:bg-input[data-state=unchecked] {
        background-color: unset;
    }

    /* Light Mode */
    .light .bg-card {
        font-family: "Roboto", "Segoe UI", "Helvetica Neue", Helvetica, Arial, sans-serif;
        position: relative;
        /* 设置元素为相对定位 */
        background-color: var(--custom-background-color);
        border: 1px solid var(--custom-border-color);
        backdrop-filter: blur(5px);
        border-radius: 15px;
        /* 设置边框圆角为15像素 */
        overflow: hidden;
        /* 确保内容不会溢出容器 */
        box-shadow: 0 4px 6px var(--custom-boxshadow-color);
        /* 设置阴影 */
    }

    .light .focus\:text-accent-foreground:focus {
        background-color: var(--custom-background-color);
    }

    .light .text-muted-foreground {
        color: #000;
    }

    .light\:bg-stone-700:is(.light *) {
        --tw-bg-opacity: 0.5;
    }

    html.light * {
        border-color: var(--custom-border-color);
    }

    html.light body {
        color: #0b0a09;
        background: unset;
        position: relative;
    }

    .border-neutral-200:is(.light *) {
        border-color: var(--custom-border-color);
    }

    .fill-neutural-200\/50:is(.light *) {
        fill: var(--custom-background-color);
    }

    .light .bg-stone-100 {
        background: var(--custom-background-color);
    }

    .light\:text-stone-500:is(.light *) {
        color: #0b0a09;
    }

    .light .bg-muted {
        background-color: var(--custom-border-color);
    }

    .bg-white:is(.light *) {
        background-color: var(--custom-boxshadow-color)
    }

    .light .bg-border {
        background-color: var(--custom-border-color);
    }

    .light .border-input {
        border-color: var(--custom-border-color);
    }

    .text-neutral-600\/50:is(.light *) {
        color: #666;
    }

    .text-stone-400:is(.light *) {
        color: #000;
    }

    .light div#radix-\:r4\: {
        background: rgba(255, 255, 255, 0.7);
    }

    .light .max-w-5xl.gap-4>div:first-child {
        background-color: var(--custom-background-color);
        backdrop-filter: blur(2px);
        border: 1px solid var(--custom-boxshadow-color);
        box-shadow: 0 4px 6px var(--custom-boxshadow-color);
        border-radius: 12px;
        padding: 12px;
    }

    .light .\[\&_\.recharts-cartesian-axis-tick_text\]\:fill-muted-foreground .recharts-cartesian-axis-tick text {
        fill: #000;
    }

    .light .data-\[state\=checked\]\:bg-primary[data-state=checked] {
        background-color: var(--custom-background-color);
    }

    .bg-neutral-100:is(.light *) {
        background-color: var(--custom-background-color);
    }

    .light .bg-secondary {
        background-color: unset;
    }

    .light .bg-popover {
        background-color: var(--custom-boxshadow-color);
    }

    .light .font-medium.opacity-40 {
        opacity: unset;
    }

    .light .font-medium.opacity-50 {
        opacity: unset;
    }

    /* Dark Mode */
    .dark .bg-card {
        font-family: "Roboto", "Segoe UI", "Helvetica Neue", Helvetica, Arial, sans-serif;
        position: relative;
        /* 设置元素为相对定位 */
        background-color: var(--custom-background-color-dark);
        border: 1px solid var(--custom-border-color-dark);
        backdrop-filter: blur(5px);
        border-radius: 15px;
        /* 设置边框圆角为15像素 */
        overflow: hidden;
        /* 确保内容不会溢出容器 */
        box-shadow: 0 4px 6px var(--custom-boxshadow-color-dark);
        /* 设置阴影 */
    }

    .dark .focus\:text-accent-foreground:focus {
        background-color: var(--custom-background-color-dark);
    }

    .dark .text-muted-foreground {
        color: #fff;
    }

    .dark\:bg-stone-700:is(.dark *) {
        --tw-bg-opacity: 0.5;
    }

    html.dark * {
        border-color: var(--custom-border-color-dark);
    }

    html.dark body {
        color: #f4f5f6;
        background: unset;
        position: relative;
    }

    .dark\:border-neutral-800:is(.dark *) {
        border-color: var(--custom-border-color-dark);
    }

    .dark\:fill-neutral-800:is(.dark *) {
        fill: var(--custom-background-color-dark);
    }

    .dark .bg-stone-800 {
        background: var(--custom-background-color-dark);
    }

    .dark\:text-stone-500:is(.dark *) {
        color: #f4f5f6;
    }

    .dark .bg-muted {
        background-color: var(--custom-border-color-dark);
    }

    .dark\:bg-black:is(.dark *) {
        background-color: var(--custom-boxshadow-color-dark)
    }

    .dark .bg-border {
        background-color: var(--custom-border-color-dark);
    }

    .dark .border-input {
        border-color: var(--custom-border-color-dark);
    }

    .dark\:text-neutral-300\/50:is(.dark *) {
        color: #999;
    }

    .dark\:text-stone-400:is(.dark *) {
        color: #fff;
    }

    .dark div#radix-\:r4\: {
        background: rgba(0, 0, 0, 0.7);
    }

    .dark .max-w-5xl.gap-4>div:first-child {
        background-color: var(--custom-background-color-dark);
        backdrop-filter: blur(2px);
        border: 1px solid var(--custom-boxshadow-color-dark);
        box-shadow: 0 4px 6px var(--custom-boxshadow-color-dark);
        border-radius: 12px;
        padding: 12px;
    }

    .dark .\[\&_\.recharts-cartesian-axis-tick_text\]\:fill-muted-foreground .recharts-cartesian-axis-tick text {
        fill: #fff;
    }

    .dark .data-\[state\=checked\]\:bg-primary[data-state=checked] {
        background-color: var(--custom-background-color-dark);
    }

    .bg-neutral-800:is(.dark *) {
        background-color: var(--custom-background-color-dark);
    }

    .dark .bg-secondary {
        background-color: unset;
    }

    .dark .bg-popover {
        background-color: var(--custom-boxshadow-color-dark);
    }

    .dark .font-medium.opacity-40 {
        opacity: unset;
    }

    .dark .font-medium.opacity-50 {
        opacity: unset;
    }

    /* 不显示自带流量卡片 */
    .mt-4.w-full.mx-auto>div {
        display: none;
    }
</style>

<script>
    //window.CustomBackgroundImage = "https://w.wallhaven.cc/full/q6/wallhaven-q6jvjl.jpg";
    window.CustomBackgroundImage = "https://bing.img.run/rand_uhd.php"; /* 页面背景图 */
    window.CustomMobileBackgroundImage = "https://bing.img.run/rand_m.php"; /* 移动端页面背景图 */
    /* 卡片显示上下行流量 */
    //window.ShowNetTransfer = "true";
    /* 关掉人物插图 */
    window.DisableAnimatedMan = "true";
    /* 自定义描述 */
    window.CustomDesc = "v2.games";

    /* 修改页脚, 可使用 HTML 元素, 请保留哪吒版权信息, 与下方 CSS 中的 不显示页脚 冲突 */
    /* 左侧哪吒文本 */
    const observerFooterLeft = new MutationObserver(() => {
        const footerLeft = document.querySelector(
            ".server-footer-name > div:first-child"
        );
        if (footerLeft) {
            footerLeft.style.visibility = "hidden"; // 隐藏
            observerFooterLeft.disconnect();
        }
    });
    observerFooterLeft.observe(document.body, { childList: true, subtree: true });
    /* 右侧主题文本 */
    const observerFooterRight = new MutationObserver(() => {
        const footerRight = document.querySelector(".server-footer-theme");
        if (footerRight) {
            footerRight.innerHTML = "<section></section>";
            observerFooterRight.disconnect();
        }
    });
    observerFooterRight.observe(document.body, {
        childList: true,
        subtree: true,
    });
</script>

<script>
    ; (function () {
        let trafficTimer = null;
        let trafficCache = null;
        let toggleIndex = 0;
        const toggleElements = [];

        const config = {
            showTrafficStats: true,
            insertPosition: 'replace', // 可选：'after', 'before', 'replace'
            interval: 60000,           // 60秒刷新周期
            toggleInterval: 5000         // 5秒切换标签信息, 0 为不切换
        };

        if (config.toggleInterval > 0) {
            setInterval(() => {
                toggleIndex = (toggleIndex + 1);
                toggleElements.forEach(({ el, contents }) => {
                    if (!document.body.contains(el)) return;
                    const index = toggleIndex % contents.length;
                    fadeOutIn(el, contents[index], 500);
                });
            }, config.toggleInterval);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return { value: '0', unit: 'B' };
            const units = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
            let unitIndex = 0;
            let size = bytes;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            return {
                value: size.toFixed(unitIndex === 0 ? 0 : 2),
                unit: units[unitIndex]
            };
        }

        function calculatePercentage(used, total) {
            used = Number(used);
            total = Number(total);
            if (used > 1e15 || total > 1e15) {
                used /= 1e10;
                total /= 1e10;
            }
            return (used / total * 100).toFixed(2);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function safeSetTextContent(parent, selector, text) {
            const el = parent.querySelector(selector);
            if (el) {
                el.textContent = text;
            }
        }
        // 根据百分比生成渐变颜色（绿色到红色）
        function getHslGradientColor(percentage) {
            const clamp = (val, min, max) => Math.min(Math.max(val, min), max);
            const lerp = (start, end, t) => start + (end - start) * t;
            const p = clamp(Number(percentage), 0, 100);
            let h, s, l;
            if (p <= 35) {
                // green → orange，降低饱和度峰值和亮度峰值
                const t = p / 35;
                h = lerp(142, 32, t);
                s = lerp(69, 85, t);  // 从69到85，替代之前的96
                l = lerp(45, 55, t);  // 从45到55，替代之前的61
            } else if (p <= 85) {
                // orange → red，降低饱和度并压缩亮度范围
                const t = (p - 35) / 50;
                h = lerp(32, 0, t);
                s = lerp(85, 75, t);  // 从85到75，之前是96到84
                l = lerp(55, 50, t);  // 从55到50，之前是61到60
            } else {
                // 红色稍微再深一点
                const t = (p - 85) / 15;
                h = 0;
                s = 75;              // 固定稍低饱和度
                l = lerp(50, 45, t); // 亮度加深但幅度缩小
            }
            return `hsl(${h.toFixed(0)}, ${s.toFixed(0)}%, ${l.toFixed(0)}%)`;
        }
        // 元素内容淡出、替换、再淡入动画，duration 单位毫秒
        function fadeOutIn(element, newContent, duration = 500) {
            element.style.transition = `opacity ${duration / 2}ms`;
            element.style.opacity = '0';

            setTimeout(() => {
                element.innerHTML = newContent;
                element.style.transition = `opacity ${duration / 2}ms`;
                element.style.opacity = '1';
            }, duration / 2);
        }

        function renderTrafficStats(trafficData) {
            const serverMap = new Map();

            for (const cycleId in trafficData) {
                const cycle = trafficData[cycleId];
                if (!cycle.server_name || !cycle.transfer) continue;

                for (const serverId in cycle.server_name) {
                    const serverName = cycle.server_name[serverId];
                    const transfer = cycle.transfer[serverId];
                    const max = cycle.max;
                    const from = cycle.from;
                    const to = cycle.to;
                    const next_update = cycle.next_update[serverId];

                    if (serverName && transfer !== undefined && max && from && to) {
                        serverMap.set(serverName, {
                            id: serverId,
                            transfer: transfer,
                            max: max,
                            name: cycle.name,
                            from: from,
                            to: to,
                            next_update: next_update
                        });
                    }
                }
            }

            serverMap.forEach((serverData, serverName) => {
                const targetElement = Array.from(document.querySelectorAll('section.grid.items-center.gap-2'))
                    .find(section => {
                        const firstText = section.querySelector('p.break-all.font-bold.tracking-tight.text-xs')?.textContent.trim();
                        return firstText === serverName;
                    });
                if (!targetElement) {
                    //console.warn(`[renderTrafficStats] 未找到服务器 "${serverName}" (ID: ${serverData.id}) 的元素`);
                    return;
                }

                const usedFormatted = formatFileSize(serverData.transfer);
                const totalFormatted = formatFileSize(serverData.max);
                const percentage = calculatePercentage(serverData.transfer, serverData.max);
                const fromFormatted = formatDate(serverData.from);
                const toFormatted = formatDate(serverData.to);
                const next_update = new Date(serverData.next_update).toLocaleString("zh-CN", { timeZone: "Asia/Shanghai" });
                const uniqueClassName = 'traffic-stats-for-server-' + serverData.id;
                const progressColor = getHslGradientColor(percentage);
                let insertPosition = config.insertPosition;

                const containerDiv = targetElement.closest('div');
                if (!containerDiv) return;

                const existing = Array.from(containerDiv.querySelectorAll('.new-inserted-element')).find(el =>
                    el.classList.contains(uniqueClassName)
                );
                if (!config.showTrafficStats) {
                    if (existing) existing.remove();
                    return;
                }

                if (existing) {
                    safeSetTextContent(existing, '.used-traffic', usedFormatted.value);
                    safeSetTextContent(existing, '.used-unit', usedFormatted.unit);
                    safeSetTextContent(existing, '.total-traffic', totalFormatted.value);
                    safeSetTextContent(existing, '.total-unit', totalFormatted.unit);
                    safeSetTextContent(existing, '.from-date', fromFormatted);
                    safeSetTextContent(existing, '.to-date', toFormatted);
                    safeSetTextContent(existing, '.percentage-value', percentage + '%');
                    safeSetTextContent(existing, '.next-update', `next update: ${next_update}`);
                    const progressBar = existing.querySelector('.progress-bar');
                    if (progressBar) {
                        progressBar.style.width = percentage + '%';
                        progressBar.style.backgroundColor = progressColor;
                    }
                    console.log(`[renderTrafficStats] 更新已存在的流量条目: ${serverName}`);
                }
                else {
                    const oldSection = containerDiv.querySelector('section.grid.items-center.gap-3');
                    if (!oldSection) return;
                    // 默认进度条右上角展示内容
                    const defaultTimeInfoHTML = `<span class="from-date">${fromFormatted}</span>
                    <span class="text-neutral-500 dark:text-neutral-400">-</span>
                    <span class="to-date">${toFormatted}</span>`;
                    // 右上角切换列表
                    const contents = [
                        defaultTimeInfoHTML,
                        `<span class="text-[10px] font-medium text-neutral-800 dark:text-neutral-200 percentage-value">${percentage}%</span>`,
                        `<span class="text-[10px] font-medium text-neutral-600 dark:text-neutral-300">${next_update}</span>`
                    ];
                    const newElement = document.createElement('div');
                    newElement.classList.add('space-y-1.5', 'new-inserted-element', uniqueClassName);
                    newElement.style.width = '100%';
                    newElement.innerHTML = `
                <div class="flex items-center justify-between">
                  <div class="flex items-baseline gap-1">
                    <span class="text-[10px] font-medium text-neutral-800 dark:text-neutral-200 used-traffic">${usedFormatted.value}</span>
                    <span class="text-[10px] font-medium text-neutral-800 dark:text-neutral-200 used-unit">${usedFormatted.unit}</span>
                    <span class="text-[10px] text-neutral-500 dark:text-neutral-400">/ </span>
                    <span class="text-[10px] text-neutral-500 dark:text-neutral-400 total-traffic">${totalFormatted.value}</span>
                    <span class="text-[10px] text-neutral-500 dark:text-neutral-400 total-unit">${totalFormatted.unit}</span>
                  </div>
                  <div class="text-[10px] font-medium text-neutral-600 dark:text-neutral-300 time-info" style="opacity:1; transition: opacity 0.3s;">
                    ${defaultTimeInfoHTML}
                  </div>
                </div>
                <div class="relative h-1.5">
                  <div class="absolute inset-0 bg-neutral-100 dark:bg-neutral-800 rounded-full"></div>
                  <div class="absolute inset-0 bg-emerald-500 rounded-full transition-all duration-300 progress-bar" style="width: ${percentage}%; background-color: ${progressColor};"></div>
                </div>
              `;
                    oldSection.after(newElement);
                    console.log(`[renderTrafficStats] 插入新流量条目: ${serverName}`);

                    // 定时切换显示内容
                    const timeInfoElement = newElement.querySelector('.time-info');
                    if (config.toggleInterval > 0 && timeInfoElement) {
                        toggleElements.push({
                            el: timeInfoElement,
                            contents
                        });
                    }
                }
            });
        }

        function updateTrafficStats(force = false) {
            const now = Date.now();
            if (!force && trafficCache && (now - trafficCache.timestamp < config.interval)) {
                console.log('[updateTrafficStats] 使用缓存数据');
                renderTrafficStats(trafficCache.data);
                return;
            }

            console.log('[updateTrafficStats] 正在请求新数据...');
            fetch('/api/v1/service')
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        console.warn('[updateTrafficStats] 请求成功但返回数据异常');
                        return;
                    }
                    console.log('[updateTrafficStats] 成功获取新数据');
                    const trafficData = data.data.cycle_transfer_stats;
                    trafficCache = {
                        timestamp: now,
                        data: trafficData
                    };
                    renderTrafficStats(trafficData);
                })
                .catch(err => console.error('[updateTrafficStats] 获取失败:', err));
        }

        function startPeriodicRefresh() {
            if (!trafficTimer) {
                console.log('[startPeriodicRefresh] 启动周期刷新任务');
                trafficTimer = setInterval(() => {
                    updateTrafficStats();
                }, config.interval);
            }
        }

        function onDomChildListChange() {
            console.log('[onDomChildListChange] 检测到DOM变化, 立即刷新');
            updateTrafficStats();
            if (!trafficTimer) {
                console.log('[onDomChildListChange] 启动定时刷新');
                startPeriodicRefresh();
            }
        }

        const TARGET_SELECTOR = 'section.server-card-list, section.server-inline-list';

        let currentSection = null;
        let childObserver = null;

        function observeSection(section) {
            if (childObserver) {
                childObserver.disconnect();
                console.log('[监听] 断开旧的子节点监听');
            }

            currentSection = section;
            console.log('[监听] 监听新的目标 section 子节点');

            childObserver = new MutationObserver(mutations => {
                for (const m of mutations) {
                    if (m.type === 'childList' && (m.addedNodes.length || m.removedNodes.length)) {
                        console.log('[监听] section 子节点变化，触发刷新');
                        onDomChildListChange();
                        break;
                    }
                }
            });

            childObserver.observe(currentSection, { childList: true, subtree: false });
            updateTrafficStats();
        }

        const sectionDetector = new MutationObserver(() => {
            const section = document.querySelector(TARGET_SELECTOR);
            if (section && section !== currentSection) {
                observeSection(section);
            }
        });

        const root = document.querySelector('main') || document.body;
        sectionDetector.observe(root, { childList: true, subtree: true });
        console.log('[初始化] 启动 sectionDetector, 持续监听 section 切换');

        startPeriodicRefresh();

        window.addEventListener('beforeunload', () => {
            if (trafficTimer) clearInterval(trafficTimer);
            if (childObserver) childObserver.disconnect();
            sectionDetector.disconnect();
            console.log('[清理] 卸载监听器和定时器');
        });
    })();
</script>
